# This is a basic workflow to help you get started with Actions

name: Build and Publish IG

# Controls when the action will run.
on:
  push:
    branches:
      - '**'
  pull_request:

permissions:
  actions: write
  contents: write
  issues: write
  pull-requests: write

jobs:

  build:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/gefyra/ig-publisher-with-snapshot-support:latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Run SUSHI (FSH -> FHIR conversion)
      - name: Run SUSHI
        run: sushi .
      
      # Run the HL7 FHIR IG Publisher
      - name: Build IG
        run: |
          igpublisher -ig ig.ini || true
          if [ -d "output" ] && [ "$(ls -A output)" ]; then
            echo "IG build produced output (Jekyll may have failed but core content exists)"
            exit 0
          else
            echo "IG build failed to produce output"
            exit 1
          fi

      - name: Record branch metadata for Pages cleanup
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/')
        run: |
          set -eu
          echo "${GITHUB_REF_NAME}" > "output/.branch-name"

      # Upload the IG build output as an artifact
      - name: Upload Build Results
        uses: actions/upload-artifact@v4
        with:
          name: fhir-ig
          path: |
            output

      # Publish the IG output to a branch-specific directory on gh-pages
      - name: Publish branch output to GitHub Pages
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/')
        shell: bash
        env:
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          set -euo pipefail

          remote_url="https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git"

          rm -rf gh-pages

          if git ls-remote --heads "${remote_url}" gh-pages | grep -q "."; then
            git clone --depth 1 --branch gh-pages "${remote_url}" gh-pages
          else
            git clone "${remote_url}" gh-pages
            cd gh-pages
            git config user.name "${GIT_AUTHOR_NAME}"
            git config user.email "${GIT_AUTHOR_EMAIL}"
            git checkout --orphan gh-pages
            git rm -rf . >/dev/null 2>&1 || true
            touch .nojekyll
            git add .nojekyll
            git commit -m "chore: initialize gh-pages"
            git push --set-upstream origin gh-pages
            cd ..
          fi

          branch_dir="gh-pages/${GITHUB_REF_NAME}"
          rm -rf "${branch_dir}"
          mkdir -p "${branch_dir}"
          cp -R "output/." "${branch_dir}/"

          cd gh-pages
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git add --all
          if git diff --cached --quiet; then
            echo "No updates to publish."
            exit 0
          fi
          git commit -m "chore: update ${GITHUB_REF_NAME} pages"
          git push origin gh-pages

      - name: Announce published URL
        id: announce_url
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/')
        shell: bash
        run: |
          set -eu
          repo_owner="${GITHUB_REPOSITORY_OWNER}"
          repo_name="${GITHUB_REPOSITORY#*/}"
          branch="${GITHUB_REF_NAME}"
          url="https://${repo_owner}.github.io/${repo_name}/${branch}/"
          echo "Published to ${url}"
          printf '### Deployment\n[Open published IG for branch `%s`](%s)\n' "${branch}" "${url}" >> "${GITHUB_STEP_SUMMARY}"
          echo "published_url=${url}" >> "${GITHUB_OUTPUT}"

      - name: Upsert PR comment with published URL
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/')
        uses: actions/github-script@v7
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          PUBLISHED_URL: ${{ steps.announce_url.outputs.published_url }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const branch = process.env.BRANCH_NAME;
            const marker = '<!-- ig-publish-url -->';
            const url = process.env.PUBLISHED_URL;
            const body = `${marker}
            ### Deployment
            [Open published IG for branch \`${branch}\`](${url})`;

            // Try to find an open PR for this branch
            const { data: prs } = await github.rest.pulls.list({
              owner, repo, state: 'open', per_page: 100
            });
            const pr = prs.find(p => p.head && p.head.ref === branch);
            if (!pr) {
              core.info(`No open PR found for branch ${branch}; skipping PR comment.`);
              return;
            }

            // List existing comments on that PR
            const { data: comments } = await github.rest.issues.listComments({
              owner, repo, issue_number: pr.number, per_page: 100
            });

            // Find existing marker comment (any author)
            const existing = comments.find(c => typeof c.body === 'string' && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner, repo, comment_id: existing.id, body
              });
              core.info(`Updated IG publish URL comment on PR #${pr.number}`);
            } else {
              await github.rest.issues.createComment({
                owner, repo, issue_number: pr.number, body
              });
              core.info(`Created IG publish URL comment on PR #${pr.number}`);
            }
